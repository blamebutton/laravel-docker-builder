#!/usr/bin/env bash

PACKAGE="$(dirname "${BASH_SOURCE[0]}")/.."

if ! [[ -f "${PWD}/public/index.php" ]]; then
  echo "Missing [/public/index.php], please run from Laravel base directory.";
  exit 1
fi

if ! [[ -f "${PWD}/.dockerignore" ]]; then
  echo "Missing [/.dockerignore], copying...";
  cp "${PACKAGE}/docker/.dockerignore" "${PWD}/.dockerignore"
fi

if ! [[ -f "$PWD/.docker/nginx.dockerfile" ]]; then
  echo "Dockerfile [/.docker/nginx.dockerfile] not found."
  echo "Run: php artisan docker:generate"
  exit 1
fi

if ! [[ -f "$PWD/.docker/php.dockerfile" ]]; then
  echo "Dockerfile [/.docker/php.dockerfile] not found."
  echo "Run: php artisan docker:generate"
  exit 1
fi

NGINX_TAG="${DOCKER_NGINX_TAG}"
PHP_TAG="${DOCKER_PHP_TAG}"

if [[ -z "${NGINX_TAG}" ]]; then
  echo "Environment variable [DOCKER_NGINX_TAG] not found."
  exit 1
fi

if [[ -z "${PHP_TAG}" ]]; then
  echo "Environment variable [DOCKER_PHP_TAG] not found."
  exit 1
fi

docker build \
  --tag "${NGINX_TAG}" \
  --file "${PWD}/.docker/nginx.dockerfile" \
  "${PWD}"

docker build \
  --tag "${PHP_TAG}" \
  --file "${PWD}/.docker/php.dockerfile" \
  "${PWD}"